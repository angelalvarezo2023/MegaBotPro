<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MegaBot PRO - Panel de Control</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* ========== PANTALLA DE SELECCI√ìN ========== */
    .selection-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: calc(100vh - 40px);
    }
    
    .selection-card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 100%;
    }
    
    .selection-card h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .selection-card .subtitle {
      color: rgba(255,255,255,0.6);
      margin-bottom: 30px;
    }
    
    .selection-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .selection-btn {
      padding: 20px;
      border: none;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }
    
    .selection-btn:hover {
      transform: scale(1.03);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .selection-btn.cliente {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .selection-btn.admin {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .selection-btn .icon {
      font-size: 28px;
    }
    
    .selection-btn .text {
      text-align: left;
    }
    
    .selection-btn .text small {
      display: block;
      font-weight: normal;
      font-size: 12px;
      opacity: 0.8;
      margin-top: 3px;
    }
    
    /* ========== PANELES ========== */
    .panel {
      display: none;
    }
    
    .panel.active {
      display: block;
    }
    
    .back-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .back-btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    /* ========== PANEL CLIENTE ========== */
    .client-panel {
      max-width: 450px;
      margin: 0 auto;
    }
    
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 24px;
      margin-bottom: 5px;
      text-align: center;
    }
    
    .card-subtitle {
      color: rgba(255,255,255,0.6);
      text-align: center;
      margin-bottom: 25px;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: rgba(255,255,255,0.8);
      font-size: 14px;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      background: rgba(255,255,255,0.9);
      color: #333;
    }
    
    .form-group input::placeholder {
      color: #999;
    }
    
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .btn:hover {
      transform: scale(1.02);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .status-message {
      padding: 12px;
      border-radius: 10px;
      text-align: center;
      margin-bottom: 15px;
      font-size: 14px;
    }
    
    .status-success { background: rgba(16,185,129,0.3); color: #6ee7b7; }
    .status-error { background: rgba(239,68,68,0.3); color: #fca5a5; }
    .status-info { background: rgba(59,130,246,0.3); color: #93c5fd; }
    
    .info-card {
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .info-row:last-child { border-bottom: none; }
    
    .info-label {
      color: rgba(255,255,255,0.6);
      font-size: 13px;
    }
    
    .info-value {
      color: white;
      font-weight: bold;
    }
    
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .badge-active { background: #10b981; }
    .badge-paused { background: #ef4444; }
    .badge-pro { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .badge-basico { background: #6b7280; }
    
    .control-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .divider {
      height: 1px;
      background: rgba(255,255,255,0.1);
      margin: 15px 0;
    }
    
    .refresh-info {
      text-align: center;
      color: rgba(255,255,255,0.4);
      font-size: 11px;
      margin-top: 15px;
    }
    
    /* ========== PANEL ADMIN ========== */
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .admin-header h1 {
      font-size: 28px;
    }
    
    .admin-header .actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-card .icon { font-size: 32px; margin-bottom: 8px; }
    .stat-card .value { font-size: 28px; font-weight: bold; margin-bottom: 5px; }
    .stat-card .label { color: rgba(255,255,255,0.6); font-size: 13px; }
    
    .stat-card.green .value { color: #10b981; }
    .stat-card.blue .value { color: #3b82f6; }
    .stat-card.purple .value { color: #8b5cf6; }
    .stat-card.yellow .value { color: #f59e0b; }
    .stat-card.red .value { color: #ef4444; }
    
    .revenue-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .revenue-card .main {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .revenue-card .amount {
      font-size: 36px;
      font-weight: bold;
    }
    
    .revenue-card .breakdown {
      text-align: right;
      font-size: 13px;
      opacity: 0.9;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 10px 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    
    .tab:hover { background: rgba(255,255,255,0.2); }
    .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .section {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .key-generator {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 768px) {
      .key-generator { grid-template-columns: 1fr; }
    }
    
    .generated-key {
      background: rgba(0,0,0,0.3);
      padding: 20px;
      border-radius: 12px;
      display: none;
    }
    
    .generated-key.show { display: block; }
    
    .key-display {
      font-size: 22px;
      font-weight: bold;
      color: #10b981;
      text-align: center;
      padding: 15px;
      background: rgba(16,185,129,0.2);
      border-radius: 10px;
      margin-bottom: 15px;
      font-family: monospace;
    }
    
    .key-info {
      font-size: 13px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 15px;
      line-height: 1.8;
    }
    
    .whatsapp-template {
      background: rgba(37,211,102,0.2);
      padding: 15px;
      border-radius: 10px;
      font-size: 12px;
      white-space: pre-line;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .btn-whatsapp {
      background: #25d366;
      color: white;
    }
    
    .btn-small {
      padding: 8px 15px;
      font-size: 13px;
      width: auto;
    }
    
    /* Tabla */
    .table-container {
      overflow-x: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th, .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .data-table th {
      color: rgba(255,255,255,0.6);
      font-weight: normal;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .data-table tr:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .search-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .search-row input {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
    }
    
    .search-row select {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }
    
    /* Alertas */
    .alert-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .alert-item.warning { border-left: 4px solid #f59e0b; }
    .alert-item.danger { border-left: 4px solid #ef4444; }
    
    .alert-item .icon { font-size: 24px; }
    .alert-item .content { flex: 1; }
    .alert-item .title { font-weight: bold; margin-bottom: 3px; }
    .alert-item .desc { font-size: 13px; color: rgba(255,255,255,0.7); }
    
    .hidden { display: none !important; }
    
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- ========== PANTALLA DE SELECCI√ìN ========== -->
    <div class="panel active" id="panel-selection">
      <div class="selection-screen">
        <div class="selection-card">
          <h1>üöÄ MegaBot PRO</h1>
          <p class="subtitle">Panel de Control</p>
          
          <div class="selection-buttons">
            <button class="selection-btn cliente" onclick="showPanel('client-login')">
              <span class="icon">üë§</span>
              <span class="text">
                Soy Cliente
                <small>Controlar mi bot remotamente</small>
              </span>
            </button>
            
            <button class="selection-btn admin" onclick="showPanel('admin-login')">
              <span class="icon">‚öôÔ∏è</span>
              <span class="text">
                Administrador
                <small>Dashboard y gesti√≥n</small>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ========== LOGIN CLIENTE ========== -->
    <div class="panel" id="panel-client-login">
      <div class="client-panel">
        <button class="back-btn" onclick="showPanel('selection')">‚Üê Volver</button>
        
        <div class="card">
          <h2 class="card-title">üë§ Acceso Cliente</h2>
          <p class="card-subtitle">Ingresa tu clave de licencia</p>
          
          <div class="form-group">
            <input type="text" id="client-key" placeholder="Ej: MEGA-JUAN-123" style="text-transform: uppercase; text-align: center;">
          </div>
          
          <div id="client-login-status" class="status-message hidden"></div>
          
          <button class="btn btn-primary" id="btn-client-login" onclick="clientLogin()">
            üîì Acceder
          </button>
        </div>
      </div>
    </div>
    
    <!-- ========== PANEL CLIENTE ========== -->
    <div class="panel" id="panel-client-control">
      <div class="client-panel">
        <button class="back-btn" onclick="clientLogout()">‚Üê Cerrar sesi√≥n</button>
        
        <div class="card">
          <h2 class="card-title">üéÆ Control Remoto</h2>
          <p class="card-subtitle">Controla tu bot desde cualquier lugar</p>
          
          <div class="info-card">
            <div class="info-row">
              <span class="info-label">üë§ Cliente</span>
              <span class="info-value" id="client-name">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">üìã Plan</span>
              <span id="client-plan"></span>
            </div>
            <div class="info-row">
              <span class="info-label">üìÖ D√≠as restantes</span>
              <span class="info-value" id="client-days">-</span>
            </div>
            <div class="info-row">
              <span class="info-label">üîÑ Estado</span>
              <span id="client-status"></span>
            </div>
          </div>
          
          <div id="client-control-status" class="status-message hidden"></div>
          
          <div class="control-buttons">
            <button class="btn btn-danger" onclick="clientAction('pausar', 'esta')">
              ‚è∏Ô∏è Pausar esta cuenta
            </button>
            <button class="btn btn-danger btn-secondary" onclick="clientAction('pausar', 'todas')">
              ‚è∏Ô∏è Pausar TODAS las cuentas
            </button>
            
            <div class="divider"></div>
            
            <button class="btn btn-success" onclick="clientAction('reanudar', 'esta')">
              ‚ñ∂Ô∏è Reanudar esta cuenta
            </button>
            <button class="btn btn-success btn-secondary" style="background: rgba(16,185,129,0.3);" onclick="clientAction('reanudar', 'todas')">
              ‚ñ∂Ô∏è Reanudar TODAS las cuentas
            </button>
          </div>
          
          <p class="refresh-info">Se actualiza autom√°ticamente cada 10 segundos</p>
        </div>
      </div>
    </div>
    
    <!-- ========== LOGIN ADMIN ========== -->
    <div class="panel" id="panel-admin-login">
      <div class="client-panel">
        <button class="back-btn" onclick="showPanel('selection')">‚Üê Volver</button>
        
        <div class="card">
          <h2 class="card-title">üîê Admin</h2>
          <p class="card-subtitle">Ingresa tu contrase√±a</p>
          
          <div class="form-group">
            <input type="password" id="admin-password" placeholder="Contrase√±a">
          </div>
          
          <div id="admin-login-status" class="status-message hidden"></div>
          
          <button class="btn btn-primary" onclick="adminLogin()">
            üîì Entrar
          </button>
        </div>
      </div>
    </div>
    
    <!-- ========== PANEL ADMIN ========== -->
    <div class="panel" id="panel-admin-dashboard">
      <div class="admin-header">
        <div>
          <h1>üöÄ MegaBot PRO</h1>
          <span style="color: rgba(255,255,255,0.6); font-size: 14px;">Panel de Administraci√≥n</span>
        </div>
        <div class="actions">
          <button class="btn btn-small btn-secondary" onclick="loadAdminData()">üîÑ Actualizar</button>
          <button class="btn btn-small btn-secondary" onclick="adminLogout()">üö™ Salir</button>
        </div>
      </div>
      
      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card green">
          <div class="icon">üë•</div>
          <div class="value" id="stat-total">-</div>
          <div class="label">Clientes</div>
        </div>
        <div class="stat-card blue">
          <div class="icon">‚úÖ</div>
          <div class="value" id="stat-activos">-</div>
          <div class="label">Activos</div>
        </div>
        <div class="stat-card purple">
          <div class="icon">‚≠ê</div>
          <div class="value" id="stat-pro">-</div>
          <div class="label">PRO</div>
        </div>
        <div class="stat-card yellow">
          <div class="icon">‚ö†Ô∏è</div>
          <div class="value" id="stat-vencen">-</div>
          <div class="label">Por vencer</div>
        </div>
        <div class="stat-card red">
          <div class="icon">üö´</div>
          <div class="value" id="stat-expirados">-</div>
          <div class="label">Expirados</div>
        </div>
      </div>
      
      <!-- Revenue -->
      <div class="revenue-card">
        <div>
          <div class="main">üí∞ Ingresos Mensuales Estimados</div>
          <div class="amount" id="stat-revenue">$0.00</div>
        </div>
        <div class="breakdown">
          PRO: <span id="revenue-pro">$0</span><br>
          B√°sico: <span id="revenue-basic">$0</span>
        </div>
      </div>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showAdminTab('generator')">üîë Generar Clave</button>
        <button class="tab" onclick="showAdminTab('clients')">üë• Clientes</button>
        <button class="tab" onclick="showAdminTab('alerts')">üîî Alertas</button>
      </div>
      
      <!-- Tab: Generator -->
      <div class="tab-content active" id="tab-generator">
        <div class="section">
          <h3 class="section-title">üîë Generador de Claves</h3>
          
          <div class="key-generator">
            <div>
              <div class="form-group">
                <label>üë§ Nombre del Cliente</label>
                <input type="text" id="gen-name" placeholder="Ej: Juan P√©rez">
              </div>
              
              <div class="form-group">
                <label>üìã Plan</label>
                <select id="gen-plan">
                  <option value="basico">B√°sico - $29.99/mes</option>
                  <option value="pro">PRO - $49.99/mes</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>üìÖ Duraci√≥n</label>
                <select id="gen-duration">
                  <option value="30">1 Mes</option>
                  <option value="60">2 Meses</option>
                  <option value="90">3 Meses</option>
                  <option value="180">6 Meses</option>
                  <option value="365">1 A√±o</option>
                </select>
              </div>
              
              <div class="form-group">
                <label>üìû WhatsApp (opcional)</label>
                <input type="text" id="gen-whatsapp" placeholder="+1234567890">
              </div>
              
              <button class="btn btn-success" onclick="generateKey()">
                ‚ö° GENERAR CLAVE
              </button>
            </div>
            
            <div class="generated-key" id="generated-key-box">
              <div class="key-display" id="gen-key-display">-</div>
              
              <div class="key-info">
                <strong>Cliente:</strong> <span id="gen-info-name">-</span><br>
                <strong>Plan:</strong> <span id="gen-info-plan">-</span><br>
                <strong>Expira:</strong> <span id="gen-info-expiry">-</span>
              </div>
              
              <button class="btn btn-secondary" onclick="copyKey()" style="margin-bottom: 10px;">
                üìã Copiar Clave
              </button>
              
              <div class="whatsapp-template" id="whatsapp-template"></div>
              
              <button class="btn btn-whatsapp" onclick="sendWhatsApp()">
                üì± Enviar por WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tab: Clients -->
      <div class="tab-content" id="tab-clients">
        <div class="section">
          <h3 class="section-title">üë• Lista de Clientes</h3>
          
          <div class="search-row">
            <input type="text" id="search-client" placeholder="üîç Buscar..." onkeyup="filterClients()">
            <select id="filter-status" onchange="filterClients()">
              <option value="all">Todos</option>
              <option value="active">Activos</option>
              <option value="paused">Pausados</option>
              <option value="expiring">Por vencer</option>
              <option value="expired">Expirados</option>
            </select>
          </div>
          
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Clave</th>
                  <th>Cliente</th>
                  <th>Plan</th>
                  <th>Expira</th>
                  <th>Estado</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="clients-table-body">
                <tr><td colspan="6" class="empty-state">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Tab: Alerts -->
      <div class="tab-content" id="tab-alerts">
        <div class="section">
          <h3 class="section-title">üîî Alertas</h3>
          <div id="alerts-container">
            <div class="empty-state">Cargando...</div>
          </div>
        </div>
      </div>
    </div>
    
  </div>

  <script>
    // ========== CONFIGURACI√ìN ==========
    const CONFIG = {
      API_URL: "https://script.google.com/macros/s/AKfycbwjkp_ahJXrKuCVfOeDR6anu3M_7XSF8eOPmGHrpwt_hBfkdCEX8GsK2jbvT7HyXShMCg/exec",
      SHEET_URL: "https://docs.google.com/spreadsheets/d/1URJ0e0znn1gCZjhI1BROP-UgZb-P9X45uM1v4S7NkRQ/export?format=csv",
      ADMIN_PASSWORD: "megabot2024",
      PRECIO_PRO: 49.99,
      PRECIO_BASICO: 29.99,
      WHATSAPP_VENDEDOR: "+1 (829) 383-7695"
    };
    
    let clientesData = [];
    let currentClientKey = null;
    let generatedKeyData = null;
    let clientPollingInterval = null;
    
    // ========== NAVEGACI√ìN ==========
    function showPanel(panelId) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById('panel-' + panelId).classList.add('active');
    }
    
    // ========== API ==========
    async function callAPI(action, params = {}) {
      try {
        const url = new URL(CONFIG.API_URL);
        url.searchParams.append('action', action);
        Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
        const response = await fetch(url.toString());
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        return { error: error.message };
      }
    }
    
    // ========== CLIENTE ==========
    async function clientLogin() {
      const key = document.getElementById('client-key').value.trim().toUpperCase();
      const statusEl = document.getElementById('client-login-status');
      const btn = document.getElementById('btn-client-login');
      
      if (!key) {
        statusEl.className = 'status-message status-error';
        statusEl.textContent = '‚ö†Ô∏è Ingresa tu clave';
        statusEl.classList.remove('hidden');
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';
      statusEl.className = 'status-message status-info';
      statusEl.textContent = 'Verificando...';
      statusEl.classList.remove('hidden');
      
      const result = await callAPI('verificar', { clave: key });
      
      btn.disabled = false;
      btn.textContent = 'üîì Acceder';
      
      if (result.encontrada) {
        currentClientKey = key;
        localStorage.setItem('megabot_client_key', key);
        updateClientPanel(result);
        showPanel('client-control');
        statusEl.classList.add('hidden');
        startClientPolling();
      } else {
        statusEl.className = 'status-message status-error';
        statusEl.textContent = '‚ùå Clave no encontrada';
      }
    }
    
    function updateClientPanel(data) {
      document.getElementById('client-name').textContent = data.cliente || '-';
      document.getElementById('client-days').textContent = data.diasRestantes + ' d√≠as';
      
      const planBadge = data.plan === 'pro' 
        ? '<span class="badge badge-pro">PRO</span>'
        : '<span class="badge badge-basico">B√ÅSICO</span>';
      document.getElementById('client-plan').innerHTML = planBadge;
      
      const isPaused = data.pausado === 'SI' || data.pausadoTodas === 'SI';
      const statusBadge = isPaused
        ? '<span class="badge badge-paused">‚è∏Ô∏è PAUSADO</span>'
        : '<span class="badge badge-active">‚ñ∂Ô∏è ACTIVO</span>';
      document.getElementById('client-status').innerHTML = statusBadge;
    }
    
    async function clientAction(action, tipo) {
      const statusEl = document.getElementById('client-control-status');
      statusEl.className = 'status-message status-info';
      statusEl.textContent = 'Procesando...';
      statusEl.classList.remove('hidden');
      
      const result = await callAPI(action, { clave: currentClientKey, tipo });
      
      if (result.success) {
        statusEl.className = 'status-message status-success';
        statusEl.textContent = '‚úÖ ' + result.mensaje;
        // Actualizar panel
        const data = await callAPI('verificar', { clave: currentClientKey });
        if (data.encontrada) updateClientPanel(data);
      } else {
        statusEl.className = 'status-message status-error';
        statusEl.textContent = '‚ùå ' + (result.error || 'Error');
      }
      
      setTimeout(() => statusEl.classList.add('hidden'), 3000);
    }
    
    function clientLogout() {
      currentClientKey = null;
      localStorage.removeItem('megabot_client_key');
      if (clientPollingInterval) clearInterval(clientPollingInterval);
      showPanel('selection');
    }
    
    function startClientPolling() {
      if (clientPollingInterval) clearInterval(clientPollingInterval);
      clientPollingInterval = setInterval(async () => {
        if (!currentClientKey) return;
        const data = await callAPI('verificar', { clave: currentClientKey });
        if (data.encontrada) updateClientPanel(data);
      }, 10000);
    }
    
    // ========== ADMIN ==========
    function adminLogin() {
      const password = document.getElementById('admin-password').value;
      const statusEl = document.getElementById('admin-login-status');
      
      if (password === CONFIG.ADMIN_PASSWORD) {
        localStorage.setItem('megabot_admin', 'true');
        showPanel('admin-dashboard');
        loadAdminData();
      } else {
        statusEl.className = 'status-message status-error';
        statusEl.textContent = '‚ùå Contrase√±a incorrecta';
        statusEl.classList.remove('hidden');
      }
    }
    
    function adminLogout() {
      localStorage.removeItem('megabot_admin');
      showPanel('selection');
    }
    
    async function loadAdminData() {
      try {
        const response = await fetch(CONFIG.SHEET_URL);
        const text = await response.text();
        const lines = text.split('\n');
        
        clientesData = [];
        
        for (let i = 2; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = line.split(',').map(s => s.trim());
          const [clave, cliente, hwid, expiracion, activo, plan, pausado, pausadoTodas] = cols;
          
          if (!cliente) continue;
          
          const fechaExp = new Date(expiracion);
          const diasRestantes = Math.ceil((fechaExp - new Date()) / (1000 * 60 * 60 * 24));
          
          clientesData.push({
            clave: clave || '',
            cliente,
            expiracion,
            diasRestantes,
            activo: activo?.toUpperCase() === 'SI',
            plan: plan?.toLowerCase() || 'basico',
            pausado: pausado?.toUpperCase() === 'SI' || pausadoTodas?.toUpperCase() === 'SI'
          });
        }
        
        updateStats();
        updateClientsTable();
        updateAlerts();
        
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }
    
    function updateStats() {
      const total = clientesData.length;
      const activos = clientesData.filter(c => c.activo && c.diasRestantes > 0).length;
      const pro = clientesData.filter(c => c.plan === 'pro' && c.activo && c.diasRestantes > 0).length;
      const basico = clientesData.filter(c => c.plan === 'basico' && c.activo && c.diasRestantes > 0).length;
      const vencen = clientesData.filter(c => c.diasRestantes > 0 && c.diasRestantes <= 7).length;
      const expirados = clientesData.filter(c => c.diasRestantes <= 0).length;
      
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-activos').textContent = activos;
      document.getElementById('stat-pro').textContent = pro;
      document.getElementById('stat-vencen').textContent = vencen;
      document.getElementById('stat-expirados').textContent = expirados;
      
      const revPro = pro * CONFIG.PRECIO_PRO;
      const revBasic = basico * CONFIG.PRECIO_BASICO;
      document.getElementById('stat-revenue').textContent = '$' + (revPro + revBasic).toFixed(2);
      document.getElementById('revenue-pro').textContent = '$' + revPro.toFixed(2);
      document.getElementById('revenue-basic').textContent = '$' + revBasic.toFixed(2);
    }
    
    function updateClientsTable() {
      const tbody = document.getElementById('clients-table-body');
      
      if (clientesData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No hay clientes</td></tr>';
        return;
      }
      
      tbody.innerHTML = clientesData.map(c => {
        let statusBadge;
        let statusClass;
        
        if (c.diasRestantes <= 0) {
          statusBadge = '<span class="badge" style="background:#dc2626;">Expirado</span>';
          statusClass = 'expired';
        } else if (c.pausado) {
          statusBadge = '<span class="badge badge-paused">Pausado</span>';
          statusClass = 'paused';
        } else if (c.diasRestantes <= 7) {
          statusBadge = '<span class="badge" style="background:#f59e0b;">Por vencer</span>';
          statusClass = 'expiring';
        } else {
          statusBadge = '<span class="badge badge-active">Activo</span>';
          statusClass = 'active';
        }
        
        const planBadge = c.plan === 'pro' 
          ? '<span class="badge badge-pro">PRO</span>'
          : '<span class="badge badge-basico">B√°sico</span>';
        
        return `
          <tr data-name="${c.cliente.toLowerCase()}" data-status="${statusClass}">
            <td><code style="color:#10b981;">${c.clave || '-'}</code></td>
            <td>${c.cliente}</td>
            <td>${planBadge}</td>
            <td>${c.expiracion} <small style="opacity:0.5;">(${c.diasRestantes}d)</small></td>
            <td>${statusBadge}</td>
            <td>
              ${c.clave ? `<button class="btn btn-small btn-secondary" onclick="copyText('${c.clave}')">üìã</button>` : ''}
            </td>
          </tr>
        `;
      }).join('');
    }
    
    function filterClients() {
      const search = document.getElementById('search-client').value.toLowerCase();
      const filter = document.getElementById('filter-status').value;
      
      document.querySelectorAll('#clients-table-body tr').forEach(row => {
        const name = row.dataset.name || '';
        const status = row.dataset.status || '';
        
        const matchSearch = name.includes(search);
        const matchFilter = filter === 'all' || status === filter;
        
        row.style.display = (matchSearch && matchFilter) ? '' : 'none';
      });
    }
    
    function updateAlerts() {
      const alerts = [];
      
      clientesData.filter(c => c.diasRestantes > 0 && c.diasRestantes <= 7).forEach(c => {
        alerts.push({
          type: 'warning',
          icon: '‚ö†Ô∏è',
          title: `${c.cliente} - Por vencer`,
          desc: `Vence en ${c.diasRestantes} d√≠as`
        });
      });
      
      clientesData.filter(c => c.diasRestantes <= 0).forEach(c => {
        alerts.push({
          type: 'danger',
          icon: 'üö´',
          title: `${c.cliente} - Expirado`,
          desc: `Expir√≥ el ${c.expiracion}`
        });
      });
      
      clientesData.filter(c => !c.clave).forEach(c => {
        alerts.push({
          type: 'warning',
          icon: 'üîë',
          title: `${c.cliente} - Sin clave`,
          desc: 'No tiene clave asignada'
        });
      });
      
      const container = document.getElementById('alerts-container');
      
      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state">‚úÖ No hay alertas</div>';
        return;
      }
      
      container.innerHTML = alerts.map(a => `
        <div class="alert-item ${a.type}">
          <div class="icon">${a.icon}</div>
          <div class="content">
            <div class="title">${a.title}</div>
            <div class="desc">${a.desc}</div>
          </div>
        </div>
      `).join('');
    }
    
    function showAdminTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
    }
    
    // ========== GENERADOR DE CLAVES ==========
    function generateKey() {
      const name = document.getElementById('gen-name').value.trim();
      const plan = document.getElementById('gen-plan').value;
      const duration = parseInt(document.getElementById('gen-duration').value);
      const whatsapp = document.getElementById('gen-whatsapp').value.trim();
      
      if (!name) {
        alert('‚ö†Ô∏è Ingresa el nombre del cliente');
        return;
      }
      
      const shortName = name.split(' ')[0].toUpperCase().replace(/[^A-Z]/g, '').substring(0, 6);
      const random = Math.floor(Math.random() * 900) + 100;
      const key = `MEGA-${shortName}-${random}`;
      
      const expiry = new Date();
      expiry.setDate(expiry.getDate() + duration);
      const expiryStr = expiry.toISOString().split('T')[0];
      
      generatedKeyData = { key, name, plan, expiry: expiryStr, whatsapp };
      
      document.getElementById('gen-key-display').textContent = key;
      document.getElementById('gen-info-name').textContent = name;
      document.getElementById('gen-info-plan').textContent = plan.toUpperCase();
      document.getElementById('gen-info-expiry').textContent = expiryStr;
      
      const template = `üöÄ *MegaBot PRO*

¬°Hola ${name}! Tu licencia est√° lista:

üîë *Clave:* ${key}
üìã *Plan:* ${plan.toUpperCase()}
üìÖ *V√°lido hasta:* ${expiryStr}

*Instrucciones:*
1. Abre megapersonals.eu
2. Presiona F12 ‚Üí Console
3. Pega el c√≥digo del bot
4. Ingresa tu clave

üì± *Control Remoto:*
${location.href}

¬øDudas? Escr√≠beme.`;
      
      document.getElementById('whatsapp-template').textContent = template;
      document.getElementById('generated-key-box').classList.add('show');
    }
    
    function copyKey() {
      if (generatedKeyData) {
        navigator.clipboard.writeText(generatedKeyData.key);
        alert('‚úÖ Copiado: ' + generatedKeyData.key);
      }
    }
    
    function copyText(text) {
      navigator.clipboard.writeText(text);
      alert('‚úÖ Copiado: ' + text);
    }
    
    function sendWhatsApp() {
      if (!generatedKeyData) return;
      const template = document.getElementById('whatsapp-template').textContent;
      let url = 'https://wa.me/';
      if (generatedKeyData.whatsapp) {
        url += generatedKeyData.whatsapp.replace(/[^0-9]/g, '');
      }
      url += '?text=' + encodeURIComponent(template);
      window.open(url, '_blank');
    }
    
    // ========== INIT ==========
    document.addEventListener('DOMContentLoaded', () => {
      // Auto-login cliente
      const savedKey = localStorage.getItem('megabot_client_key');
      if (savedKey) {
        currentClientKey = savedKey;
        document.getElementById('client-key').value = savedKey;
        clientLogin();
      }
      
      // Auto-login admin
      if (localStorage.getItem('megabot_admin') === 'true') {
        showPanel('admin-dashboard');
        loadAdminData();
      }
      
      // Enter keys
      document.getElementById('client-key').addEventListener('keypress', e => {
        if (e.key === 'Enter') clientLogin();
      });
      document.getElementById('admin-password').addEventListener('keypress', e => {
        if (e.key === 'Enter') adminLogin();
      });
    });
  </script>
</body>
</html>
